#!/bin/bash
# This file is part of the jetson_stats package (https://github.com/rbonghi/jetson_stats or http://rnext.it).
# Copyright (c) 2019 Raffaello Bonghi.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

red=`tput setaf 1`
green=`tput setaf 2`
reset=`tput sgr0`

TITLE="Jetson software configurator"
# List of all health functions
HEALT_FUNCTIONS=("folders" "Check folders"\
                 "variables" "Check variables status"\
                 "jetson_performance" "Status jetson clock service"\
                 "jetson_stats_up" "Jetson-stats startup service")
# Jetson-stats main folder
JETSON_STATS_FOLDER="/usr/local/jetson_stats"
# Require reboot
REQUIRE_REBOOT=false
# Locate jetson-stats and python version
JTOP_VARIABLE=$(python3 -c "import jtop; print(jtop.__path__[0])")
JTOP_PYTHON="3"
if [ -z "$JTOP_VARIABLE" ] ; then
    JTOP_VARIABLE=$(python -c "import jtop; print(jtop.__path__[0])")
    JTOP_PYTHON="2.7"
fi


status_folders()
{
    
    if [ -d "/etc/jetson_easy" ] ; then
        echo 1
        return
    fi
    if [ -d "/opt/jetson_stats" ] ; then
        echo 1
        return
    fi
    if [ -d $JETSON_STATS_FOLDER ] ; then
        echo 0
        return
    fi
    # Everythin is fine
    echo 0
}

folders()
{
    local TEXT=""
    if [ $(status_folders) -eq 0 ] ; then
        TEXT="All folder are correctly installed"
    else
        TEXT="Clean and reinstall all folders."
    fi
    whiptail --title "$TITLE" --msgbox "$TEXT" 8 78
    # Return to healt function
    health
}

status_jetson_performance()
{
    # Check if jetson_performance is executable
    if [ -x "$JETSON_STATS_FOLDER/jetson_performance.sh" ] ; then
        echo 0
        return
    else
        echo 1
        return
    fi
    # Check if jetson performance is correctly installed
    local JE_PERFOMANCE_STATUS="$(systemctl is-active jetson_performance.service)"
    if [ $JE_PERFOMANCE_STATUS = "failed" ] || [ $JE_PERFOMANCE_STATUS = "inactive" ] ; then
        echo 1
        return
    else
        echo 0
        return
    fi
    echo 0
}

jetson_performance()
{
    local TEXT="Status jetson_performance. The jetson_clock service.\n"
    if [ -x "$JETSON_STATS_FOLDER/jetson_performance.sh" ] ; then
        TEXT+=" - jetson_performance.sh is executable\n"
    else
        TEXT+=" - jetson_performance.sh is NOT executable\n"
    fi
    # Status service
    local JE_PERFOMANCE_STATUS="$(systemctl is-active jetson_performance.service)"
    TEXT+=" - jetson_performance service is $JE_PERFOMANCE_STATUS"
    whiptail --title "$TITLE" --msgbox "$TEXT" 10 78
    # Return to healt function
    health
}

status_jetson_stats_up()
{
    if [ -x "$JETSON_STATS_FOLDER/jetson_fan.sh" ] ; then
        echo 0
        return
    else
        echo 1
        return
    fi

    local JE_FAN_STATUS="$(systemctl is-active jetson_fan.service)"
    if [ $JE_FAN_STATUS = "failed" ] ; then
        echo 1
        return
    else
        echo 0
        return
    fi
}

jetson_stats_up()
{
    local TEXT="Status jetson_stats_up. The jetson_stats start-up service.\n"
    if [ -x "$JETSON_STATS_FOLDER/jetson_fan.sh" ] ; then
        TEXT+=" - jetson_fan.sh is executable\n"
    else
        TEXT+=" - jetson_fan.sh is NOT executable\n"
    fi
    # Status service
    local JETSON_STATS_FOLDER="$(systemctl is-active jetson_fan.service)"
    TEXT+=" - jetson_fan service is $JETSON_STATS_FOLDER"
    whiptail --title "$TITLE" --msgbox "$TEXT" 10 78
    # Return to healt function
    health
}

status_variables()
{
    if [ -f "/etc/profile.d/jetson_env.sh" ] ; then
        echo 0
    else
        echo 1
    fi
}

fix_variables()
{
    sudo cp "$JETSON_STATS_FOLDER/jetson_env.sh" "/etc/profile.d/jetson_env.sh"
}

variables()
{
    local TEXT="Jetson variable is:\n"
    # Run script to fix variables
    fix_variables
    # Check status variables
    if [ $(status_variables) -eq 0 ] ; then
        TEXT+=" - Fixed"
    else
        TEXT+=" - Failure"
    fi
    whiptail --title "$TITLE" --msgbox "$TEXT" 8 78
    # Return to healt function
    health
}

fix_all()
{
    echo "Fix all"
    local LIST=("$@")
    for i in "${LIST[@]}"; do
        # Check if a status function in list return error=1
        echo "$i"
        if [ $i -eq 1 ] ; then
            echo "Fix: $i"
        fi
    done
}

write_status()
{
    if [ $1 -eq 1 ] ; then
        echo "n"
    else
        echo "Y"
    fi
}

status_healt()
{
    local LIST=("$@")
    # Evaluate length list
    local LIST_LEN
    let LIST_LEN=${#LIST[@]}-1
    # Check if there is a function require fix
    for i in `seq 0 2 $LIST_LEN`; do
        # Read name
        local name=${HEALT_FUNCTIONS[$i]}
        # Evaluate status
        local status=$(eval "status_$name")
        # Check if a status function in list return error=1
        if [ $status -eq 1 ] ; then
            return 1
        fi
    done
    return 0
}

health()
{
    # Evaluate the size
    local HEALT_FUNCTIONS_LEN
    let HEALT_FUNCTIONS_LEN=${#HEALT_FUNCTIONS[@]}-1
    local OK_BUTTON="Fix"
    # Make menu
    local MENU="jetson-stats configuration\n"
    MENU+=" - Folder scripts: $JETSON_STATS_FOLDER\n"
    MENU+=" - jtop installed on python $JTOP_PYTHON\n"
    MENU+=" - jtop path: $JTOP_VARIABLE\n"
    MENU+="Choose an option:"
    # Build Menu healt list
    local MENU_LIST=("<-- Back" "Return to the main menu.")
    # Build menu list
    for i in `seq 0 2 $HEALT_FUNCTIONS_LEN`; do
        # Read name
        local name=${HEALT_FUNCTIONS[$i]}
        local description=${HEALT_FUNCTIONS[$i+1]}
        # Evaluate status
        local status=$(eval "status_$name")
        #echo $i $name $status
        MENU_LIST+=("[$(write_status $status)] $name" "$description")
    done
    # Make jetson_stats menu
    if status_healt "${HEALT_FUNCTIONS[@]}" ; then
        OK_BUTTON="Ok"
    else
        MENU_LIST+=("Fix" "Fix all packages")
    fi
    # Evaluate the size
    local MENU_LIST_LEN
    let MENU_LIST_LEN=${#MENU_LIST[@]}/2
    local OUTPUT
    OUTPUT=$(whiptail --title "$TITLE" --ok-button "$OK_BUTTON" --cancel-button "return" --menu "$MENU" 18 78 $MENU_LIST_LEN "${MENU_LIST[@]}" 3>&1 1>&2 2>&3)
    # Read exit status
    if [ $? -eq 0 ]; then
        # Run the function with the same name
        if [ "$OUTPUT" = "<-- Back" ] ; then
            main
        elif [ "$OUTPUT" = "Fix" ] ; then
            fix_all "${HEALT_FUNCTIONS[@]}"
        else
            # Extract function name
            local FUNCTION=$(echo $OUTPUT | cut -d " " -f2)
            # Evaluate status
            local status=$(eval "status_$FUNCTION")
            # Run function
            $FUNCTION
        fi
    else
        # Return to main for other options
        main
    fi
}


desktop()
{
    whiptail --title "$TITLE" --msgbox "Desktop box" 8 78
    # Return to main menu
    main
}


update()
{
    whiptail --title "$TITLE" --msgbox "Update box" 8 78
    # Return to main menu
    main
}


about()
{
    whiptail --msgbox "\
This tool provides a straight-forward way of doing initial
configuration of your NVIDIA jetson. Although it can be run
at any time, some of the options may have difficulties if
you have heavily customised your installation.\
" 20 70 1
    # Return to main menu
    main
}


main()
{
    local MENU_LIST=("health" "Check the status of jetson-stats"\
                     "desktop" "Enable/Disable boot from desktop"\
                     "update" "Update this tool to the latest version"\
                     "about"  "Information about this configuration tool")
    # Evaluate the size
    local MENU_LIST_LEN
    let MENU_LIST_LEN=${#MENU_LIST[@]}/2
    # If exist argument pass directly the name
    if [ ! -z "$1" ] ; then
        if type $1 | grep -i function > /dev/null; then
            $1
            exit 0
        fi
    fi
    # Make jetson_stats menu
    local OUTPUT
    OUTPUT=$(whiptail --title "$TITLE" --ok-button "Select" --cancel-button "Finish" --menu "" 15 78 $MENU_LIST_LEN "${MENU_LIST[@]}" 3>&1 1>&2 2>&3)
    # Read exit status
    if [ $?=0 ]; then
        # Run the function with the same name
        $OUTPUT
    fi
    # Print request to reboot
    if $REQUIRE_REBOOT ; then
        echo "${red}Require reboot!${reset}"
    fi
}


main $@
exit 0
# EOF
